# kms-least-priv-asm

<!--BEGIN STABILITY BANNER-->
---

![Stability: Stable](https://img.shields.io/badge/stability-Stable-success.svg?style=for-the-badge)

> **This is a stable example. It should successfully build out of the box**
>
> This examples is built on Construct Libraries marked "Stable" and does not have any infrastructure prerequisites to build.

---
<!--END STABILITY BANNER-->

Writing key management service (KMS) key policies can be complex because they can contain multiple statements that specify different permissions for different users and services. This can make it challenging for a developer to understand the overall permissions granted by the policy, especially if the policy is long or contains many statements.

One way to implement the least privilege in a KMS key policy is to use the [grantRead](https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-secretsmanager.Secret.html#grantwbrreadgrantee-versionstages) method in the Cloud Development Kit (CDK) and a [kms:ViaService](https://docs.aws.amazon.com/kms/latest/developerguide/policy-conditions.html#conditions-kms-via-service) condition. This allows you to grant read permissions for a specific service, such as a Lambda execution role, while still maintaining control over which services have access to the key.

Additionally, you can use resource-based policies to specify which IAM roles are allowed to read the secret. This can help to further restrict access and reduce the risk of unauthorized access.

## Build

To build this app, you need to be in this example's root folder. Then run the following:

```bash
npm install -g aws-cdk
npm install
npm run build
```

This will install the necessary CDK, then this example's dependencies, and then build your TypeScript files and your CloudFormation template.

## Test

To test the app after it is built, you can run `npm test` in this example's root folder. This will utilize the CDK
[assertions](https://docs.aws.amazon.com/cdk/api/latest/docs/assertions-readme.html) library and run Jest.

## Deploy

Run `cdk deploy`. This will deploy / redeploy your Stack to your AWS Account.

After the deployment you will see the Sample Lambda name. 


## Verify

You can invoke a test event from the AWS Lambda console or you can use below AWS CLI to `invoke` the test result. 

```bash
aws lambda invoke --function-name asmFetchLambdaKmsLeastPrivAsmStack --payload '{"dummykey":"dummyvalue"}' response.json
```

A new `response.json` would be created which should contain the secrets credentials which is only allowed to be fetched from Lambda exec 
IAM role. 

## Synthesize Cloudformation Template

To see the Cloudformation template generated by the CDK, run `cdk synth`, then check the output file in the "cdk.out" directory.

## Cleanup

To clean up, issue `cdk destroy` command. 