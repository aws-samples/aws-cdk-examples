name: Build Pull Request

on: [pull_request]

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: ['csharp', 'go','python', 'java', 'typescript']
    steps:
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Runs docker builds with JSII superchain
        run: |
          echo "::group::Build changes for ${{ matrix.language }}"
          echo ""
          buildlang="${{ matrix.language }}"

          langfiles=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep "^$buildlang" )
          if [[ $langfiles == "" ]]; then 
            echo "Nothing to do"
            touch success
            echo "::endgroup::"
            exit 0
          fi

          echo "# Build summary for ${buildlang}" >> $GITHUB_STEP_SUMMARY
          buildpath=""
          # For each file that is in the changed set
          for file in $langfiles
          do
            # Split the path into the language, example, and 
            IFS="/" read path1 path2 extra <<<"$file"
            if [[ $path1 != $buildlang ]]; then
              continue
            fi 
            if [[ "$buildpath" == "$path1/$path2" ]]; then
              continue
            fi
            buildpath=$path1/$path2
            echo "Build Path ${buildpath}"
            
            # make sure there's nothing funny left over.
            git clean -dfx

            scripts/build-${buildlang}.sh $path2
            
            if [[ $? == 0 ]]; then
              echo "- :o: $buildpath" >> $GITHUB_STEP_SUMMARY
            else
              echo "- :x: $buildpath" >> $GITHUB_STEP_SUMMARY
            fi 
          done
          echo "::endgroup::"

